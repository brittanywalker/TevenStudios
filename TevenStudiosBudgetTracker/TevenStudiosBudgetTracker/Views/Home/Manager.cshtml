@model TevenStudiosBudgetTracker.Models.ManagerViewData

<style>
	.item:hover {
		background-color: azure;
	}

    .EmployeeListContainer {
        display: flex;
    }

	.showinfo {
		flex: 1;
		margin-right: 10px;
	}
</style>

@{
    ViewData["Title"] = "Manager Page";
}
<h1>@Model.CurrentUser.Name</h1>

<h2>Employees</h2>

<div class="EmployeeListContainer">
	<div class="showinfo">
		<table class="table">
			<tr>
				<th>
					ID
				</th>
				<th>
					Name
				</th>
				<th>
					Email
				</th>
			</tr>

			@for (int i = 0; i < Model.Employees.Count; i++)
			{
				<tr class="item" onclick="showSelectedUserInfo(@Model.Employees[i].ID)">
					<td>
						@Html.DisplayTextFor(modelItem => Model.Employees[i].ID)
					</td>
					<td>
						@Html.DisplayFor(modelItem => Model.Employees[i].Name)
					</td>
					<td>
						@Html.DisplayFor(modelItem => Model.Employees[i].Email)
					</td>
				</tr>
			}
		</table>
	</div>

    <!-- Div to contain information about the selected user (right side of manager page)-->
	<div class="showinfo">
        <!-- div to display employee name-->
        <div>
            <h1 id="employee_info_name" style="text-align:center"></h1>
        </div>

        <!-- div to display employee current balance-->
        <div>
            <h1 id="employee_current_balance" style="text-align:center"></h1>
        </div>
        <br />

        <!-- div to display employee pending requests table-->
        <div id="employee_pending_requests">
			<h2>All Pending Requests</h2>
			<table class="table">
				<tr>
					<th>
						Date
					</th>
					<th>
						ID
					</th>
					<th>
						Name
					</th>
					<th>
						Email
					</th>
					<th>
						Cost
					</th>
					<th>
						Description
					</th>
					<th>
						Approve
					</th>
					<th>
						Decline
					</th>
				</tr>

				@for (int i = 0; i < Model.PendingRequests.Count; i++)
				{
					<tr class="@Model.PendingRequests[i].ID">
						<td>
							@Html.DisplayTextFor(modelItem => Model.PendingRequests[i].Date)
						</td>
						<td>
							@Html.DisplayTextFor(modelItem => Model.PendingRequests[i].UserID)
						</td>
						<td>
							@Html.DisplayFor(modelItem => Model.PendingRequests[i].UserName)
						</td>
						<td>
							@Html.DisplayFor(modelItem => Model.PendingRequests[i].UserEmail)
						</td>
						<td>
							@Html.DisplayFor(modelItem => Model.PendingRequests[i].Cost)
						</td>
						<td>
							@Html.DisplayFor(modelItem => Model.PendingRequests[i].Description)
						</td>
						<td>
							<button id="approveButton" type="button" class="btn btn-info" onclick="ApproveRequestAllRequests(@Model.PendingRequests[i].ID)">Approve</button>'
						</td>
						<td>
							<button id="declineButton" type="button" class="btn btn-info" onclick="DeclineRequestAllRequests(@Model.PendingRequests[i].ID)">Decline</button>'
						</td>
					</tr>
				}
			</table>
        </div>
        <br />

        <!-- div to display employee past requests table-->
        <div id="employee_past_requests">
        </div> 
		
	</div>

	<script>
        //This function updates the HTML div for the employee info depending which employee is selected
        function showSelectedUserInfo(UserID) {
            // userId = -1 if the userId was not sent to the modal correctly
            // otherwise makes call to get user info from database
            if (UserID != -1) {
                $.ajax({
                    url: '/Home/GetSelectedInfo',
                    data: { UserID: UserID },
                }).done(function (returnData) {

                    // Set the name and current balance div for the employee
                    $("#employee_info_name").text(returnData["selectedEmployee"]['name']);
                    $("#employee_current_balance").text("$" + returnData["currentBudget"] + " available");


                    //-------------- Pending request table population --------------------

                    // Set the headings of the table
                    var html = '<h2>Pending Requests </h2> \
                        <table id="pending_request_table" class="table table-hover table-bordered" > \
                            <thead> \
                            <tr>\
                                <th data-field="Date" >\
                                    Date\
                                </th>\
                                <th data-field="Cost">\
                                    Cost\
                                </th>\
                                <th data-field="Description">\
                                    Description\
                                </th>\
                                <th data-field="Approve" >\
                                    Approve\
                                </th>\
                                <th data-field="Decline" >\
                                    Decline\
                                </th>\
                            </tr>\
                                </thead>\
                        <tbody>';

                    // add each pending request to the table
                    for (item in returnData["pendingRequests"]) {
                        html += '<tr><td>'
                            + returnData["pendingRequests"][item].date
                            + '</td><td class="">'
                            + returnData["pendingRequests"][item].cost
                            + '</td><td class="">'
                            + returnData["pendingRequests"][item].description
                            + '</td>'
                            + '<td><button id="approveButton" type="button" class="btn btn-info" onclick="ApproveRequest('
                            + returnData["pendingRequests"][item].id + ',' + returnData["id"]
                            + ')">Approve</button>'
                            + '</td>'
                            + '<td><button id="declineButton" type="button" class="btn btn-info" onclick="DeclineRequest('
                            + returnData["pendingRequests"][item].id + ',' + returnData["id"]
                            + ')">Decline</button>'
                            + '</td></tr> ';
                    }
                    html += "</tbody> </table>"

                    // update the html of the div to contain the table
                    $('#employee_pending_requests').html(html);

                    //-------------- Past request table population --------------------

                    // Set the headings of the table
                    var html = '<h2>Past Requests </h2> \
                        <table id="past_request_table" class="table table-hover table-bordered" > \
                            <thead> \
                            <tr>\
                                <th data-field="Date" >\
                                    Date\
                                </th>\
                                <th data-field="Cost">\
                                    Cost\
                                </th>\
                                <th data-field="Description">\
                                    Description\
                                </th>\
                                <th>\
                                    Status\
		                        </th>\
                            </tr>\
                                </thead>\
                        <tbody>';

                    // add each pending request to the table
                    for (item in returnData["pastRequests"]) {
                        html += '<tr><td>'
                            + returnData["pastRequests"][item].date
                            + '</td><td class="">'
                            + returnData["pastRequests"][item].amount
                            + '</td><td class="">'
                            + returnData["pastRequests"][item].description
                            + '</td><td class="">'
                            + returnData["pastRequests"][item].statusType
                            + '</td></tr>';
                    }
                    html += "</tbody>"

                    // update the html of the div to contain the table
                    $('#employee_past_requests').html(html);

                });
            } else {
                alert("Sorry, there was an error processing your request. Please try again.");
            }
        }

        function ApproveRequest(requestID, id) {
            $.ajax({
                url: '/Home/ApproveRequest',
                data: { ID: requestID },
            }).done(function () {
                showSelectedUserInfo(id);
            });
		}

		function ApproveRequestAllRequests(requestID) {
			$.ajax({
				url: '/Home/ApproveRequest',
				data: { ID: requestID },
			}).done(function () {
				window.location = "/Home/Manager";
			});
		}

        function DeclineRequest(requestID, id) {
            $.ajax({
                url: '/Home/DeclineRequest',
                data: { ID: requestID },
            }).done(function () {
                showSelectedUserInfo(id);
            });
		}

		function DeclineRequestAllRequests(requestID) {
			$.ajax({
				url: '/Home/DeclineRequest',
				data: { ID: requestID },
			}).done(function () {
				window.location = "/Home/Manager";
			});
		}
	</script>
</div>

